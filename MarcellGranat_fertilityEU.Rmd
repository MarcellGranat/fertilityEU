---
title: "The effect of socio-economic indicators on the fertilty rates"
subtitle: "An empirical analysis of fertility rates amoung the regions of Europe"
author: "Marcell Granát"
date: \today
output: 
  pdf_document: 
    fig_caption: yes
    toc: yes
    toc_depth: 4
header-includes:
- \usepackage{fancyhdr}
- \usepackage{natbib}
- \pagestyle{fancy}
- \fancyhf{}
- \fancyhead[LE,RO]{Marcell Granát}
- \fancyhead[RE,LO]{\leftmark}
- \fancyfoot[C]{\thepage}
- \usepackage{lscape}
- \usepackage{pdfpages}
- \usepackage{titling}
- \pretitle{\begin{center}\LARGE\includegraphics[width=5cm]{logo.png}\\[\bigskipamount]}
- \posttitle{\end{center}}
editor_options: 
  chunk_output_type: inline
---

\pagebreak

\begin{abstract}
Here is the abstract.
\end{abstract}

\pagebreak

```{r setup, include=FALSE, warning=F}
knitr::opts_chunk$set(echo = F, comment = "", warning = F, message = F, cache = F, dev = "cairo_pdf", error = T)
```

```{r packages}
# Set up --------------------------------------------------------------------------------

## Packages ============================================================================= 

library(tidyverse)
library(patchwork)
library(knitr)
library(broom)
library(eurostat)

## Gg theme =============================================================================

update_geom_defaults("point", list(fill = "#B1339E", 
                                   shape = 21, 
                                   color = "black", 
                                   size = 1.4))
update_geom_defaults("line", 
                     list(color = "midnightblue", size = 1.4))

update_geom_defaults("smooth", list(color = "red4", size = 1.4))

update_geom_defaults("density", 
                     list(color = "midnightblue", fill =  "midnightblue", alpha = .3, size = 1.4))

extrafont::loadfonts(device="win")

theme_set(theme_minimal() + theme(
  legend.direction = "vertical",
  # text = element_text(family = "Impact"),
  plot.caption = element_text(family = "serif")
))

```

\pagebreak

# Introduction

Ay alábbi rövid kézirat a brit **Family Expenditure Survey** adataiból kinyert fogyasztási jellemzőket tárgyalja. Az empirikus elemzés egyszerű lineáris regresszió alkalmazásával készül. Az adatok összesen 1519 család jövedelmét és kiadását tartalmazzák, továbbá 6 termékcsoport (alkohol, ruházkodás, nem alkoholtartalmú élelmiszer, fűtés, közlekedés, egyéb) fogyasztáson belüli részarányát. Dolgozatom során én kizárólag az egy gyermekes családokra szűkítem az elemzést^[Feladatkiírás által előírt megkötés.].

```{r fig.cap = "Seemingly negative effect of gross domestic product on fertility rates based on nation level observations (2017)"}
# https://data.worldbank.org/indicator/SP.DYN.TFRT.IN

WB_fertility <- read_csv("WB_fertility.csv",
                         skip = 4)

# https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD

WB_GDP <- read_csv("WB_GDP.csv",
                   skip = 4)

merge(WB_fertility %>% 
        select('Country Name', '2017') %>% 
        rename(tfr = '2017'),
      WB_GDP %>% 
        select('Country Name', '2017') %>% 
        rename(GDP = '2017')) %>% 
  ggplot(aes(GDP, tfr)) + geom_point() +
  ggformula::geom_spline() +
  scale_x_continuous(limits = c(0, 7e+4)) +
  labs(y = "Total fertility rate (birth per woman)", 
       x = "GDP per capita, PPP (constant 2017 international USD)",
       caption = "Own editing based on the Figure 5-2. from Kreiszné Hudák (2019).
       The trend is drawn via splines.
       Source of the data: World Bank."
  )

```

```{r plot_NUTS2}
plot_NUTS2 <- function(df, viridis_c = T, ..., all.x = F) {
  p <- df %>%
    {merge(eurostat::get_eurostat_geospatial(nuts_level = 2), ., all.x = all.x)} %>% 
    ggplot(aes(fill = values)) +
    geom_sf(color = "black") +
    theme(
      axis.text = element_blank()   
    ) +
    xlim(c(-30, 44)) +
    ylim(c(35, 70)) +
    labs(fill = NULL)
  
  if (viridis_c) {
    p <- p + scale_fill_viridis_c(option = "magma", ...,
                                  guide = guide_colorbar(frame.colour = "black", 
                                                         ticks.colour = "black"),
                                  na.value = "white")
  }
  p
}

```


# Data

```{r}
# Data import ---------------------------------------------------------------------------

# Eurostat database =====================================================================

f_data <- get_eurostat("demo_r_find2", time_format = "num") %>% 
  select(geo, time, var = indic_de, values)


```


```{r}
# Data from Global Data Labor ===========================================================

### Sub-national data ###################################################################

# source of csv files: https://globaldatalab.org/

GDL_import <- function(x) {
  get_eurostat_geospatial(nuts_level = 2) %>% 
    data.frame() %>% 
    tibble %>% 
    mutate(
      ISO_Code = countrycode::countrycode(CNTR_CODE, origin = "iso2c", "iso3c"),
      ISO_Code = ifelse(CNTR_CODE == "UK", "GBR", ISO_Code),
      ISO_Code = ifelse(CNTR_CODE == "EL", "GRC", ISO_Code),
    ) %>% 
    select(ISO_Code, NUTS_NAME, geo) %>% 
    merge(read_csv(x), by = "ISO_Code") %>% 
    mutate(
      z = stringdist::stringsim(NUTS_NAME, Region)
    ) %>% 
    arrange(desc(z)) %>% 
    filter(!duplicated(Region)) %>% 
    filter(!duplicated(NUTS_NAME)) %>% 
    filter((z > .5 | Country %in% c("Greece", "Turkey", 'Romania',
                                    'Malta', 'Italy')) & NUTS_NAME != "Dresden") %>% 
    select(geo, '1990':'2018') %>% 
    pivot_longer(-1, names_to = "time", values_to = "values") %>% 
    mutate(time = as.numeric(time))
}

GDL_subnat <- GDL_import("GDL-Sub-national-HDI-data.csv") %>% rename(HDI = values) %>% 
  merge(
    GDL_import("GDL-Educational-index--data.csv") %>% rename(education = values)
  ) %>% 
  merge(
    GDL_import("GDL-Health-index-data.csv") %>% rename(health = values)
  ) %>% 
  merge(
    GDL_import("GDL-Income-index-data.csv") %>% rename(income = values)
  )

### National data #######################################################################

GDL_nat <- read_csv("GDL-Sub-national-HDI-data.csv") %>%
  filter(Level == "National") %>% 
  select(Country, 6:34) %>% pivot_longer(-1, names_to = "time", values_to = "values") %>% 
  mutate(time = as.numeric(time)) %>% 
  na.omit()

# Data from UNDP ========================================================================

# source: http://hdr.undp.org/

HDI_UNDP <- read_csv("Human Development Index (HDI).csv",
                     skip = 5) %>% 
  select(!starts_with("X"), - 'HDI Rank') %>% 
  mutate_at(-1, 
            function(x) {as.numeric(ifelse(x == "..", NA, x))}) %>% 
  pivot_longer(-1, names_to = "time", values_to = "values") %>% 
  mutate(time = as.numeric(time)) %>% 
  na.omit()

```

## Human development

```{r}
merge(GDL_nat %>% rename(GDL = values),
      HDI_UNDP %>% rename(UNDP = values)) %>% 
  {
    c(
      scales::percent(cor(x = .$GDL, y = .$UNDP)^2, accuracy = .01), 
      scales::percent(cor(x = .$GDL, y = .$UNDP, method = "spearman")^2, accuracy = .01),
      as.character(format(mean(abs(.$GDL - .$UNDP)), digits = 1)),
      scales::percent(mean(abs(.$GDL - .$UNDP)/.$UNDP), accuracy = .01)
    )
  } %>% 
  {tibble(
    Indicator = c("$R^2$", "Spearman $R^2$", 
                  "Mean absolute deviation", "Mean absolute percentage deviation"),
    Value = .
  )} %>% 
  kable(
    caption = "Indicators of similiarity between the Human Development Indices 
    provided by UNDP and GDL"
  )

```

### A decent standard of living

```{r}
GDP_index <- get_eurostat("nama_10r_2gdp", time_format = "num") %>% 
  filter(unit == "PPS_HAB") %>%  # Purchasing power standard (PPS) per inhabitant
  select(-unit) %>%
  rename(GDP = values) %>% merge(
    get_eurostat("ert_bil_eur_a", time_format = "num") %>% # EUR/USD annual avg exc r
      filter(currency == "USD" & statinfo == "AVG") %>% 
      select(time, e = values)
  ) %>% 
  {
    GDP <- .$GDP/.$e # mutate to USD
    mutate(.,
           GDPindex = (log(GDP) - log(100))/
             (log(75000) - log(100))
    )
  }
```


```{r}
merge(GDL_subnat, GDP_index) %>% 
  {
    c(
      scales::percent(cor(x = .$income, y = .$GDPindex)^2, accuracy = .01), 
      scales::percent(cor(x = .$income, y = .$GDPindex, method = "spearman")^2, accuracy = .01),
      as.character(format(mean(abs(.$income - .$GDPindex)), digits = 1, nsmall = 4)),
      scales::percent(mean(abs(.$income - .$GDPindex)/.$GDPindex), accuracy = .01)
    )
  } %>% 
  {tibble(
    Indicator = c("$R^2$", "Spearman $R^2$", 
                  "Mean absolute deviation", "Mean absolute percentage deviation"),
    Value = .
  )} %>% 
  kable(
    caption = "Indicators of similiarity between the income component of the 
    Human Development Indices provided by GDL and the estimation based on regional GDP"
  )
```

```{r fig.cap = "Calculated income index based on regional GDP data"}
GDP_index %>% 
  filter(time == 2017) %>% 
  select(geo, values = GDPindex) %>% 
  plot_NUTS2
```

```{r}
health_index <- get_eurostat("demo_r_mlifexp", time_format = "num") %>% 
  filter(age == "Y_LT1" & sex == "T") %>% 
  select(geo, time, le = values) %>% 
  mutate(
    health_index = (le - 20) / (85 - 20)
  )
```

### Long and healthy life

```{r}
merge(GDL_subnat, health_index) %>% 
  {
    c(
      scales::percent(cor(x = .$health, y = .$health_index)^2, accuracy = .01), 
      scales::percent(cor(x = .$health, y = .$health_index, method = "spearman")^2, accuracy = .01),
      as.character(format(mean(abs(.$health - .$health_index)), digits = 1, nsmall = 4)),
      scales::percent(mean(abs(.$health - .$health_index)/.$health_index), accuracy = .01)
    )
  } %>% 
  {tibble(
    Indicator = c("$R^2$", "Spearman $R^2$", 
                  "Mean absolute deviation", "Mean absolute percentage deviation"),
    Value = .
  )} %>% 
  kable(
    caption = "Indicators of similiarity between the health component of the 
    Human Development Indices provided by GDL and the estimation based on regional life expectency"
  )
```

### Knowledge

```{r}
edu_wide <- get_eurostat("edat_lfse_04", time_format = "num") %>% 
  filter(sex == "T" & !str_detect(isced11, "GEN") & 
           !str_detect(isced11, "VOC") & isced11 != "ED3-8"
  ) %>% 
  mutate(
    var = str_c(age, ":", isced11)
  ) %>% 
  select(geo, time, var, values) %>% 
  pivot_wider(names_from = var, values_from = values) %>% 
  {
    x <- .
    names(x) <- letters[1:length(x)]
    x <- cbind(
      .[, 1:2],
      mice::complete(mice::mice(select(x, -a,-b), printFlag = F))
    )
    names(x) <- names(.)
    x
  }
```

```{r fig.cap='PCAs and the explained variance'}
edu_comps <- edu_wide%>% 
  select(-time, -geo) %>% 
  na.omit() %>% 
  {princomp(scale(.))}

edu_comp_vars <- edu_comps %>% 
  summary() %>% 
  {.$sdev^2/sum(.$sdev^2)} %>% 
  scales::percent(accuracy = .01) %>% 
  {str_c("# ", 1:length(.), " (", ., ")")}

edu_comps %>% 
  .$loadings %>% 
  unclass() %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  pivot_longer(-1) %>% 
  mutate(
    name = as.numeric(str_remove(name, 'Comp.')),
  ) %>% 
  arrange(name) %>% 
  mutate(
    name = edu_comps %>% 
      summary() %>% 
      {.$sdev^2/sum(.$sdev^2)} %>% 
      scales::percent(accuracy = .01) %>% 
      {str_c("# ", 1:length(.), " (", ., ")")} %>% 
      .[name]
  ) %>% 
  ggplot +
  aes(rowname, value, fill = value < 0) +
  geom_hline(yintercept = 0) +
  geom_col(color = 'black') +
  coord_flip() +
  scale_fill_viridis_d(guide = F, option = "magma", begin = .4,
                       end= .7, direction = -1) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~name, ncol = 3) +
  labs(x = NULL, y = NULL, caption = 
         "The corresponding proportion of the explained variance are in the brackets.")
```


```{r}
edu_comps %>% .$scores %>% 
  cbind(edu_wide) %>% merge(GDL_subnat) %>% 
  select(3:11, education) %>% 
  {
    x <- .$education
    apply(select(., -education), 2, function(y) {
      c(
        scales::percent(cor(x = x, y = y)^2, accuracy = .01), 
        scales::percent(cor(x = x, y = y, method = "spearman")^2, accuracy = .01)
      )
    })
  } %>% 
  data.frame() %>% 
  mutate(Indicator = c("$R^2$", "Spearman $R^2$")) %>% 
  rename_all(function(x) str_replace(x, "p.", "p ")) %>% 
  select(Indicator, 1:9) %>% 
  kable(
    caption = "Indicators of similiarity between the knowledge component of Human Development Indices 
    provided by UNDP and the calculated principal components using educational attainment level"
  )
```

```{r}
edu_index <- edu_comps %>% 
  .$scores %>% 
  data.frame() %>% 
  select(2) %>% 
  cbind(edu_wide) %>% 
  select(geo, time, edu_index = Comp.2) %>% 
  mutate(
    edu_index = -edu_index,
    edu_index = edu_index + abs(min(edu_index)),
    edu_index = edu_index/max(edu_index)
  ) 
```

```{r}
dat <- f_data %>% 
  pivot_wider(names_from = var, values_from = values) %>% 
  merge(edu_index, all = T) %>% 
  merge(health_index, all = T) %>% 
  merge(GDP_index, all = T) 
```

```{r}
FAM_df <- get_eurostat("spr_exp_sum", time_format = "num") %>% 
  filter(spdeps == "FAM" & unit == "PC_GDP") %>% 
  rename(FAM = values, country = geo) %>% 
  select(-(spdeps:unit)) 

```

```{r}
yth_empl_byage <- get_eurostat("yth_empl_110", time_format = "num") %>% 
  filter(unit == "PC" & sex == "F") %>%
  filter(age %in% c("Y15-19", "Y20-24", "Y25-29")) %>% 
  select(-unit, -sex) %>% 
  pivot_wider(names_from = age, values_from = values) %>% 
  rename(
    "uY15"  = "Y15-19",
    "uY20"  = "Y20-24",
    "uY25"  = "Y25-29"
  )

```

```{r}
dat <- dat %>% 
  mutate(country = str_sub(geo, end = 2)) %>% 
  merge(FAM_df, all.x = T, all.y = F) %>% 
  merge(yth_empl_byage, all.x = T, all.y = F)

```

# Explore data

```{r}
dat %>% 
  filter(str_length(geo) == 4) %>% 
  select(TOTFERRT, GDPindex, edu_index, health_index) %>% 
  rename(
    'TFR'= 'TOTFERRT',
    'Income index' = 'GDPindex',
    'Health index' = 'health_index',
    'Education index' = 'edu_index'
  ) %>% 
  GGally::ggpairs()

```

```{r fig.height=6}
dat %>% 
  filter(str_length(geo) == 4) %>% 
  select(TOTFERRT, uY15, uY20, uY25) %>% 
  set_names("TFR", "Unemployment rate\n(15-19 years old)",
            "Unemployment rate\n(20-24 years old)",
            "Unemployment rate\n(25-29 years old)") %>% 
  GGally::ggpairs()
```


```{r}
dat %>% 
  filter(str_length(geo) == 2) %>% 
  ggplot(aes(FAM, TOTFERRT)) + geom_point() +
  ggformula::geom_spline() +
  labs(y = "Total fertility rate (birth per woman)", 
       x = "Family benefit (% of GPD)",
       caption = "The trend is drawn via splines."
  )

```

```{r fig.cap = "Regression tree explaining the TFR (cp = 0.02)"}
m_part <- dat %>% 
  filter(str_length(geo) == 4) %>% 
  select(TOTFERRT, GDPindex, edu_index, health_index) %>% 
  rename(
    'Income index' = 'GDPindex',
    'Health index' = 'health_index',
    'Education index' = 'edu_index'
  ) %>%
  na.omit() %>% 
  rpart::rpart(formula = TOTFERRT ~ ., cp = .02)

m_part %>% rattle::fancyRpartPlot(palettes = 'PuRd', sub = NULL)

```

```{r eval=F}
m_part %>% summary()
```


```{r}
m_part2 <- dat %>% 
  filter(str_length(geo) == 4) %>% 
  select(TOTFERRT, GDPindex, edu_index, health_index, uY15, uY20, uY25) %>% 
  rename(
    'Income index' = 'GDPindex',
    'Health index' = 'health_index',
    'Education index' = 'edu_index',
    'Unemployment rate at age 15-19' = 'uY15'
  ) %>%
  na.omit() %>% 
  rpart::rpart(formula = TOTFERRT ~ ., cp = .02)

m_part2 %>% rattle::fancyRpartPlot(palettes = 'PuRd', sub = NULL)

```

```{r fig.cap = "HDI and its components based on the dataset from Global Data Lab (2017)"}
GDL_subnat %>% 
  filter(time == 2017) %>% 
  select(-time) %>% 
  pivot_longer(-1, names_to = "var", values_to = "values") %>% 
  filter(!is.na(var)) %>% 
  mutate(
    var = str_to_title(var),
    var = str_replace(var, "Hdi", "HDI"),
    var = factor(var, 
                 levels = c("HDI", "Income", "Education", "Health"), 
                 ordered = T)
  ) %>% 
  plot_NUTS2() + facet_wrap(~ var, ncol = 2) +
  labs(caption = "Source: https://globaldatalab.org")

```

```{r}
fertility_byage <- get_eurostat("demo_r_frate2", time_format = "num") %>% 
  filter(age != "TOTAL") %>% 
  transmute(age = age, geo = geo, time, values)

fr_agegroups_wide <- fertility_byage %>% 
  mutate(age = str_remove(age, "Y"), # sorting into categories by 5 years
         age = str_remove(age, "10-"),
         age = str_remove(age, "_GE"),
         age = as.numeric(age),
         age_group = paste0((age %/% 5)*5, "-", (age %/% 5 + 1)*5 - 1),
         age_group = ifelse(age_group == "50-54", "50-", age_group)
  ) %>% 
  group_by(age_group, time, geo) %>% 
  summarise(values = sum(values)) %>% 
  ungroup() %>%
  pivot_wider(names_from = "age_group", values_from = "values") %>% 
  select(-"10-14", -"50-") %>% 
  na.omit() %>% 
  arrange(time, geo)

```

```{r, fig.cap='PCAs and the explained variance'}
fr_age_comps <- fr_agegroups_wide %>% 
  select(-time, -geo) %>% 
  na.omit() %>% 
  {princomp(scale(.))}

fr_age_comp_vars <- fr_age_comps %>% 
  summary() %>% 
  {.$sdev^2/sum(.$sdev^2)} %>% 
  scales::percent(accuracy = .01) %>% 
  {str_c("# ", 1:length(.), " (", ., ")")}

fr_age_comps %>% 
  .$loadings %>% 
  unclass() %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  pivot_longer(-1) %>% 
  mutate(
    name = as.numeric(str_remove(name, 'Comp.')),
  ) %>% 
  arrange(name) %>% 
  mutate(
    name = fr_age_comps %>% 
      summary() %>% 
      {.$sdev^2/sum(.$sdev^2)} %>% 
      scales::percent(accuracy = .01) %>% 
      {str_c("# ", 1:length(.), " (", ., ")")} %>% 
      .[name]
  ) %>% 
  ggplot +
  aes(rowname, value, fill = value < 0) +
  geom_hline(yintercept = 0) +
  geom_col(color = 'black') +
  coord_flip() +
  scale_fill_viridis_d(guide = F, option = "magma", begin = .4,
                       end= .7, direction = -1) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~name, ncol = 3) +
  labs(x = NULL, y = NULL, caption = 
         "The corresponding proportion of the explained variance are in the brackets.")

```


# Model building

```{r}
dat_plm <- dat %>% 
  select(
    geo, time, TOTFERRT, edu_index, health_index, GDPindex, FAM, uY15, uY20, uY25
  ) %>% 
  filter(str_length(geo) == 4 & !is.na(TOTFERRT))
```

```{r}
dat_plm <- dat_plm %>% 
  select(-TOTFERRT) %>% 
  mutate(time = time + 1) %>% 
  {
    set_names(., ifelse(names(.) == 'geo' | names(.) == 'time', names(.), paste0(names(.), '_l')))
  } %>% 
  merge(dat_plm, all.x = F, all.y = T)

dat_plm <- dat_plm %>% 
  select(!ends_with("_l")) %>% 
  select(-TOTFERRT) %>% 
  mutate(time = time + 2) %>% 
  {
    set_names(., ifelse(names(.) == 'geo' | names(.) == 'time', names(.), paste0(names(.), '_l_l')))
  } %>% 
  merge(dat_plm, all.x = F, all.y = T)

dat_plm <- dat_plm %>% 
  select(-TOTFERRT) %>% 
  mutate_at(-(1:2), function(x) x^2) %>% 
  {
    set_names(., ifelse(names(.) == 'geo' | names(.) == 'time', names(.), paste0(names(.), '_2')))
  } %>% 
  merge(dat_plm, all.x = F, all.y = T)

```


```{r}
library(plm)

m_panels <- c(
  "TOTFERRT ~  GDPindex_l_l + FAM_l_l + uY15_l_l + uY20_l_l + uY25_l_l + edu_index_l + health_index_l + GDPindex_l + FAM_l + uY15_l + uY20_l + uY25_l + edu_index + health_index + GDPindex + FAM + uY15 + uY20 + uY25",
  "TOTFERRT ~ edu_index + health_index + GDPindex + FAM + uY15 + uY20 + uY25",
  "TOTFERRT ~ edu_index") %>% 
  lapply(function(formula) {
    pooling <- plm(eval(formula), data = dat_plm, model = "pooling")
    within <- plm(eval(formula), data = dat_plm, model = "within")
    random <- plm(eval(formula), data = dat_plm, model = "random")
    
    list(
      tests = c(
        pooltest(pooling, within)$p.value,
        phtest(within, random)$p.value,
        plm::r.squared(within, dfcor = T)),
      model = within,
      OLS = lm(data = dat_plm, formula = eval(paste(formula, "+ geo")))
    )
  })
```





```{r out.extra='angle=90'}
m_panels %>% 
  lapply(function(output) {
    output$model %>% broom::tidy(conf.int = T) %>% 
      rownames_to_column()
  }) %>% 
  reduce(rbind) %>% 
  mutate(rowname = paste0("Model ", as.roman(cumsum(rowname == 1)), ".")) %>% 
  ggplot() +
  aes(estimate, term, color = p.value <= .05) +
  geom_vline(xintercept = 0, color = "gray4") +
  geom_point() +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  facet_wrap(~rowname, nrow = 1) +
  theme_grey() +
  labs(x = "Estimated coefficient", y = "Term", color = "p-value <= 5%")

```

```{r}
m_panels %>% 
  lapply(function(output) {
    output$tests
  }) %>% 
  reduce(rbind) %>% 
  t() %>% 
  data.frame() %>% 
  mutate_all(function(x) scales::percent(x, accuracy = .01)) %>% 
  {set_names(., paste0("Model ", as.roman(1:ncol(.)), ".")) } %>% 
  mutate(
    Indicator = c("pooltest", "phtest", "$Adjusted R^2$")
  ) %>% # TODO ORDER
  select(Indicator, everything()) %>% 
  knitr::kable(caption = "Models") # TODO NAME

```

```{r}
library(glmnet)

y <- na.omit(dat_plm)$TOTFERRT
X <- model.matrix(TOTFERRT ~ ., data = select(na.omit(dat_plm), -time))
LASSO <- cv.glmnet(X, y)

```
```{r}
tidy(LASSO) %>%
  ggplot() + 
  aes(log(lambda), ymin = conf.low*1000, ymax = conf.high*1000) +
  geom_line(aes(log(lambda), estimate*1000, color = "Mean-Squared Error")) +
  geom_step(aes(y = (156 - nzero), color = "Number of used explanatory variables"), size = 1) +
  geom_ribbon(alpha = .4) + 
  geom_vline(aes(xintercept = log(LASSO$lambda.1se), color = "lambda.1se"), linetype = 2) +
  geom_vline(aes(xintercept = log(LASSO$lambda.min), color = "lambda.min"), linetype = 2) +
  scale_y_continuous(
    name = "Number of used explanatory variables",
    sec.axis = sec_axis( trans=~./1000, name = "Mean-Squared Error")
  ) +
  labs(y = "Mean-Squared Error", x = "Log(\u03BB)", color = NULL) +
  scale_color_viridis_d(option = "magma", end = .8) +
  theme(legend.position = "bottom", legend.direction = "horizontal")

```

```{r}
lasso_coefs <- capture.output(
  coef(LASSO, LASSO$lambda.1se)
) %>% 
  .[-(1:2)] %>% 
  {tibble(x = .)} %>% 
  mutate(term = gsub(" .*", "", x), coef = gsub(".* ", "", x)) %>% 
  select(-x) %>% 
  filter(!str_detect(term, "geo") & coef != "" & term != "(Intercept)")

```

```{r}
m_panels2 <- paste("TOTFERRT ~", paste(lasso_coefs$term, collapse = " + ")) %>% 
  lapply(function(formula) {
    pooling <- plm(eval(formula), data = dat_plm, model = "pooling")
    within <- plm(eval(formula), data = dat_plm, model = "within")
    random <- plm(eval(formula), data = dat_plm, model = "random")
    
    list(
      tests = c(
        pooltest(pooling, within)$p.value,
        phtest(within, random)$p.value,
        plm::r.squared(within, dfcor = T)),
      model = within,
      OLS = lm(data = dat_plm, formula = eval(paste(formula, "+ geo")))
    )
  }
  )

```

```{r eval = F}
m_panels2 %>% 
  lapply(function(output) {
    output$tests
  }) 

```

```{r}
standard_beta <- m_panels2[[1]]$OLS %>% 
  QuantPsyc::lm.beta() %>% 
  {tibble(term = names(.), beta = .)} %>% 
  filter(!str_detect(term, "geo"))

standard_beta <- augment(m_panels2[[1]]$OLS) %>% 
  select(TOTFERRT:uY25) %>% 
  cor() %>% 
  data.frame() %>% 
  select(1) %>% 
  rownames_to_column() %>% 
  rename(term = rowname) %>% 
  merge(standard_beta) %>% 
  mutate(explain = TOTFERRT*beta) %>% 
  select(term, cor = TOTFERRT, standard_beta = beta, explain)

```




\pagebreak
\nocite{*}
\bibliography{fertilityEU}
\bibliographystyle{agsm}

\pagebreak

# Appendix: R codes

```{r ref.label=setdiff(knitr::all_labels(), c("setup")), eval=FALSE, echo=T, attr.source='.numberLines'}
```